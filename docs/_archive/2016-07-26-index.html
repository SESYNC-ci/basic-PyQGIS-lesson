---
---

<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title></title>
  <meta name="description" content="">

  <style type="text/css">

   body {
  background-color: #fff;
  padding:50px;
  font: 14px/1.5 "Helvetica Neue", Helvetica, Arial, sans-serif;
  color:#727272;
  font-weight:400;
}

h1, h2, h3, h4, h5, h6 {
  color:#222;
  margin:0 0 20px;
}

p, ul, ol, table, pre, dl {
  margin:0 0 20px;
}

h1, h2, h3 {
  line-height:1.1;
}

h1 {
  font-size:28px;
}

h2 {
  color:#393939;
}

h3, h4, h5, h6 {
  color:#494949;
}

a {
  color:#39c;
  text-decoration:none;
}

a:hover {
  color:#069;
}

a small {
  font-size:11px;
  color:#777;
  margin-top:-0.3em;
  display:block;
}

a:hover small {
  color:#777;
}

.wrapper {
  width:860px;
  margin:0 auto;
}

blockquote {
  border-left:1px solid #e5e5e5;
  margin:0;
  padding:0 0 0 20px;
  font-style:italic;
}

code, pre {
  font-family:Monaco, Bitstream Vera Sans Mono, Lucida Console, Terminal, Consolas, Liberation Mono, DejaVu Sans Mono, Courier New, monospace;
  color:#333;
  font-size:12px;
}

pre {
  padding:8px 15px;
  background: #f8f8f8;
  border-radius:5px;
  border:1px solid #e5e5e5;
  overflow-x: auto;
}

table {
  width:100%;
  border-collapse:collapse;
}

th, td {
  text-align:left;
  padding:5px 10px;
  border-bottom:1px solid #e5e5e5;
}

dt {
  color:#444;
  font-weight:700;
}

th {
  color:#444;
}

img {
  max-width:100%;
}

header {
  width:270px;
  float:left;
  position:fixed;
  -webkit-font-smoothing:subpixel-antialiased;
}

header ul {
  list-style:none;
  height:40px;
  padding:0;
  background: #f4f4f4;
  border-radius:5px;
  border:1px solid #e0e0e0;
  width:270px;
}

header li {
  width:89px;
  float:left;
  border-right:1px solid #e0e0e0;
  height:40px;
}

header li:first-child a {
  border-radius:5px 0 0 5px;
}

header li:last-child a {
  border-radius:0 5px 5px 0;
}

header ul a {
  line-height:1;
  font-size:11px;
  color:#999;
  display:block;
  text-align:center;
  padding-top:6px;
  height:34px;
}

header ul a:hover {
  color:#999;
}

header ul a:active {
  background-color:#f0f0f0;
}

strong {
  color:#222;
  font-weight:700;
}

header ul li + li + li {
  border-right:none;
  width:89px;
}

header ul a strong {
  font-size:14px;
  display:block;
  color:#222;
}

section {
  width:500px;
  float:right;
  padding-bottom:50px;
}

small {
  font-size:11px;
}

hr {
  border:0;
  background:#e5e5e5;
  height:1px;
  margin:0 0 20px;
}

footer {
  width:270px;
  float:left;
  position:fixed;
  bottom:50px;
  -webkit-font-smoothing:subpixel-antialiased;
}

@media print, screen and (max-width: 960px) {

  div.wrapper {
    width:auto;
    margin:0;
  }

  header, section, footer {
    float:none;
    position:static;
    width:auto;
  }

  header {
    padding-right:320px;
  }

  section {
    border:1px solid #e5e5e5;
    border-width:1px 0;
    padding:20px 0;
    margin:0 0 20px;
  }

  header a small {
    display:inline;
  }

  header ul {
    position:absolute;
    right:50px;
    top:52px;
  }
}

@media print, screen and (max-width: 720px) {
  body {
    word-wrap:break-word;
  }

  header {
    padding:0;
  }

  header ul, header p.view {
    position:static;
  }

  pre, code {
    word-wrap:normal;
  }
}

@media print, screen and (max-width: 480px) {
  body {
    padding:15px;
  }

  header ul {
    width:99%;
  }

  header li, header ul li + li + li {
    width:33%;
  }
}

@media print {
  body {
    padding:0.4in;
    font-size:12pt;
    color:#444;
  }
}

   
   .text-document pre {
       background-color: #000000;
   }

   .text-document code {
       color: #FFFFFF;
   }

   div.text-document::before {
       content: attr(title);
       font-family:Monaco, Bitstream Vera Sans Mono, Lucida Console, Terminal, Consolas, Liberation Mono, DejaVu Sans Mono, Courier New, monospace;
       font-size: 14px;
       color: #000000;
       background: #C0C0C0;
       padding:8px 15px;
       border-radius:5px 5px 0px 0px;
       border:1px solid #e5e5e5;
       display: block;
   }
   
   .text-document pre {
       border-radius: 0px 0px 5px 5px;
   }


   .input pre {
       background-color: #EBECE4;
   }
   
   .output pre {
       background-color: #ECECC7;
   }
   
  </style>
</head>


  <body>

    <div class="page-content">
      <div class="wrapper">
        <h1 id="scripting-geospatial-analysis">Scripting Geospatial Analysis</h1>

<p>Instructor: Ian Carroll</p>

<h2 id="objectives-for-this-lesson">Objectives for this Lesson</h2>

<h2 id="specific-achievements">Specific Achievements</h2>

<h2 id="qgis">QGIS</h2>

<p>QGIS is a software package that does its very best to ease the process of navigating, editing and processing spatial data.
As we will see, it is built on top of the open source libraries and it too is free to distribute and enhance.</p>

<p>It’s a GUI too, so it’s time to explore!</p>

<p>Access the PostgreSQL server to vizualize the location of US Highways.</p>

<dl>
  <dt>Name</dt>
  <dd>postGIS
Host</dd>
  <dd>pgstudio.research.sesync.org
Port</dd>
  <dd>5432
Database</dd>
  <dd>postgis_in_action
Username</dd>
  <dd>student
Password</dd>
  <dd>
    <hr />
  </dd>
</dl>

<p>We are going to calculate the length of US Route 50, all of its segments put together.</p>

<p>In the “Select features using expression” window, we’ll use:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"name" like '%US Route 50%'
</code></pre>
</div>

<h2 id="pyqgis">PyQGIS</h2>

<p>When you initiate a Python Console from within QGIS, the python environment is primed for interactive work with all aspects of the GIS software.</p>

<p>Entering the following commands in the script editor, not directly in the console, because we’re going to use them again.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Mac
data = '%sandbox%/data/'

# # Windows
# data = '%sandbox\data\\'

tif = 'westernfires_vir_2015231_geo.tif'
tif_name = 'vir'
rlayer = iface.addRasterLayer(data + tif, tif_name)
</code></pre>
</div>

<p>We are looking at the night sky, over the western United States, as seen by the Visible Infrared Imaging Radiometer Suite (VIIRS) sensor.
We are going to embark on the quest of attempting to say which areas lighting up this map are cities, the rest are a group of wildfires that were often in the news last summer.</p>

<p>Open a new project, so we can look at something else:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>shp = 'ne_10m_urban_areas'
shp_name = 'urban_areas'
vlayer = iface.addVectorLayer(data + shp, shp_name, 'ogr')
</code></pre>
</div>

<p>This is a global extent dataset on urban areas, and it is a vector data type rather than a raster.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vlayer.selectedFeatureCount()
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>for feature in vlayer.selectedFeatures():
  geom = feature.geometry()
  id = feature.id()
  ct = geom.centroid().asPoint()
  print "Feature ID: %s, Centroid: %s" % (id, ct)
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>for feature in vlayer.selectedFeatures():
  geom = feature.geometry()
  id = feature.id()
  sr = feature['scalerank']
  print "Feature ID: %s, Scale rank: %s" % (id, sr)
</code></pre>
</div>

<p>Open a new project, and we’ll look at both of these together.
Run the full script you’ve typed up so far.</p>

<p>QGIS has now conveniently layered on top of the raster our shapefile defining outlines of urban areas.</p>

<dl>
  <dt>Question</dt>
  <dd>From what we know about these datasets, or can learn using GDAL, should we be surprised that these line up?</dd>
</dl>

<p>On the fly transformation is a blessing and a curse.
You have to be aware of whether the tools you use within QGIS are actually using the “on the fly” projection or the projection of the data source.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import qgis.analysis as qa
calc = qa.QgsZonalStatistics(vlayer, rlayer.source(), "b1_",
	                         1, qa.QgsZonalStatistics.Mean)
calc.calculateStatistics(None)
</code></pre>
</div>

<p>Find the attribute table for the vector layer to see what we’ve achieved.</p>

<dl>
  <dt>Question</dt>
  <dd>If we don’t want an “OTF” transformation, do we now know a tool to make the transformation “on the <em>file</em>”.</dd>
</dl>

<p>Replace the code above to get your transformed raster.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tif = 'westernfires_vir_2015231_geo-wgs84.tif'
tif_name = 'vir'
rlayer = iface.addRasterLayer(data + tif, tif_name)
</code></pre>
</div>

<p>Notice the OTF indicator hasn’t come up.</p>

<dl>
  <dt>Question</dt>
  <dd>What ideas do we have to use these two datasets to find the wildfires? In other words, what’s a strategy for “zeroing” out the pixels in the raster dataset that fall within these polygons?</dd>
</dl>

<p>Step 1 is to give our urban areas a little wiggle room.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>msk_shp = 'urban_area_mask.shp'
qa.QgsGeometryAnalyzer().buffer(vlayer, data + msk_shp, 0.1, False, False, -1)
</code></pre>
</div>

<p>Step 2 is to convert the enlarged polygons to a raster that will serve as a mask: it only has zeros and ones.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import os

msk_tif = 'urban_area_mask.tif'
sys_call = ' '.join([
    'gdal_rasterize -ot Byte -burn 1 -tr 0.01 0.01 -l',
    msk_shp[:-4],
    data + msk_shp,
    data + msk_tif
	])
os.system(sys_call)
msk = iface.addRasterLayer(data + msk_tif, "uam")
</code></pre>
</div>

<p>Could we use a PyQGIS method to achieve this – yes, we probably could.
What the method will be, however, is a “wrapper” to the underlying GDAL utility.
Sometimes a system call is the only way to proceed if you can’t find a “wrapper” or find that it’s broken.</p>

<p>A raster calculator is just a way of doing algebra that’s forgiving of our poorly aligned matrices.</p>


      </div>
    </div>

  </body>

</html>
